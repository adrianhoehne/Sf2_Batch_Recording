#!/bin/bash

### Values ##################################################

user_values=("0" "0" "0" "0" "0" "0" "0" "0" "0")
bank_effect=("leer" "leer" "leer" "leer" "leer" "leer" "leer" "leer" "leer" "leer" "leer" "leer")
option_key=("a" "y" "s" "x" "d" "c" "f" "v" "g" "b" "h" "n" "j" "m" "k" "," "l" ".")
control_key=(" r " " e " " t " "1-9" " z " " 0 " " p " " o " " i " " u ")
control_key_desc=("Reset Values" "Load Values" "Save Values" "Load Bank" "Delete Bank" "Switch Bank" "Play Testsound" "Refresh GUI" "Play All" "Save All")

### function delete_bank ########################################
function delete_bank {
	printf " Which bank do you want to remove? :"
	read which_bank
	delete_bank_name="${bank_effect[$which_bank-1]}"
	rm "savenload/$delete_bank_name"
	bank_effect[$which_bank-1]="leer"
	if [[ "$EFFECT_NAME" -eq "$delete_bank_name" ]]; then
		unset effect_options
       		unset max_values
        	unset step_size
        	unset user_values
	fi
}

### function reset ##############################################
function reset_user_values {
i=0
index=${#user_values[*]}
while [[ "$i" -lt "$index" ]]; do
	user_values[$i]="0"
	i=$[$i+1]
done
unset i
unset index
}

### function load ###############################################
function load_user_values {
if [[ -e savenload/$EFFECT_NAME ]]; then 
	load_values=( $( cat savenload/$EFFECT_NAME ) )
	i=1
	index="${#load_values[*]}"
	while [[ "$i" -lt "$index" ]]; do
		user_values[$i-1]="${load_values[$i]}"
		i=$[$i+1]
	done
fi
unset i
unset index
} 

### funktion save  ##############################################
function save {
if ! [[ -z "$EFFECT_NAME" ]]; then
	if ! [[ "$EFFECT_NAME" -eq "leer" ]]; then
		temp_effect="$EFFECT_NAME"
		i=0
		index="${#effect_options[*]}"
		while [[ "$i" -lt "$index" ]]; do
		        usr_values="${user_values[$i]}"
			temp_effect="$temp_effect"' '"$usr_values"
		        i=$[$i+1]
		done
		echo $temp_effect > "savenload/$EFFECT_NAME"
	fi
fi
unset i
unset index
unset usr_values
}

### Function save_all #######################################
function save_all {
	save
#todo
}

### Function preload ########################################
function preload {
save
EFFECTS_FOLDER='effect_desc/'
ls $EFFECTS_FOLDER > /var/tmp/effect_maker
printf "\n"
if ! [[ "$1" -eq "0" ]]; then
	cat -n /var/tmp/effect_maker
	printf '\nChoose an effect in integer :'
	read CHOOSE_EFFECT
	EFFECT_NAME=$(tail +$CHOOSE_EFFECT /var/tmp/effect_maker | head -1)
	bank_effect[$1-1]=$EFFECT_NAME
else
	x=0
	z="${#bank_effect[*]}"
	while [[ "$x" -lt "$z" ]]; do 
		t=$[$x+1]
		if ! [[ "${bank_effect[$x]}" == "leer" ]]; then
			printf "$t"'. '"${bank_effect[$x]}  "
		fi
		x=$[$x+1]
		if [[ $( echo "$t % 6 |bc" ) -eq "0" ]]; then
			printf "\n"
		fi
	done
	printf "Which bank do you want to switch to: "
	test_it="leer"
	while [[ "$test_it" -eq "leer" ]]; do
		read CHOOSE_EFFECT	
		test_it="${bank_effect[$CHOOSE_EFFECT-1]}"
	done
	EFFECT_NAME="$test_it"
fi
EFFECT=( $( cat $EFFECTS_FOLDER""$EFFECT_NAME ) )

index="${#EFFECT[*]}"
i=0
y=0
while [[ "$i" -lt "$index" ]]; do
	effect_options[$y]="${EFFECT[$i]}"
	max_values[$y]="${EFFECT[$i+1]}"
	step_size[$y]="${EFFECT[$i+2]}"
	user_values[$y]="${EFFECT[$i+3]}"
	i=$[$i+4]
	y=$[$y+1]
done
if  [[ "$1" -eq "0" ]]; then
	load_user_values
fi
unset i
unset y
unset x
unset z
unset index
unset CHOOSE_EFFECT
}
### Function gui_balken #####################################
function gui_balken {
display_var_as_block "$1" "12"
display_var_as_block "$2" "12"
display_var_as_block "$3" "12"
display_var_as_block "$4" "4"
display_var_as_block "$5" "4"

printf "\n"
}

### Function gui_text #####################################
function gui_text {
pos=$(echo "$1" |wc -m )
max=20
printf "  "$1
while [[ "$pos" -lt "$max" ]]; do
	printf " "
	pos=$[$pos+1]
done
unset pos
unset max
}

### Function gui_bank ########################################
function gui_bank {
i=0
index="${#bank_effect[*]}"
while [[ "$i" -lt "$index" ]]; do
	y=$[$i+1]
	if [[ "$y" -gt 9 ]]; then
		transport="$y"'.'"${bank_effect[$i]}"
	else
		transport="0$y"'.'"${bank_effect[$i]}"
	fi
	if [[ "${bank_effect[$i]}" = "$EFFECT_NAME" ]]; then
		transport="$transport"'.'"active" 
	fi
	gui_text $transport
	if [[ "$i" = 3 || "$i" = 7 ]]; then
		printf "\n"
	fi
	i=$[$i+1]
done
printf "\n"
unset i
unset y
unset transport
}

### Function keydescriptions ################################
function key_desc {
	i=0
	index="${#control_key[*]}"
	while [[ "$i" -lt "$index" ]]; do
		display_var_as_block "   < ${control_key[$i]} >" "5"
		display_var_as_block "${control_key_desc[$i]}" "15"
		if [[ $( echo "( $i + 1 ) % 3" | bc  ) -eq 0 ]]; then 
			 printf "\n"
		fi
		i=$[$i+1]
	done
printf "\n"
unset i
unset index
}

### Function line ###########################################
function line {
        i=0
        while [[ "$i" -lt 80 ]]; do
                printf "#"
                i=$[$i+1]
        done
        printf "\n"
	unset i
}

### Function lbr ############################################
function lbr {
	printf "\n"
}

### Funtion display_var_as_block (var, blocksize) ##########
function display_var_as_block {
printf "$1"
pos=$( echo "$1" | wc -m )
while [[ "$pos" -lt "$2" ]]; do
        printf " "
	pos=$[$pos+1]
done
unset pos
}

### Function header ########################################
function header {
	line
	lbr
	gui_bank
	lbr
	line
}
### Function footer ########################################

function footer {
	line
	lbr
	key_desc
	lbr
	printf "   Message for you: $error1 \n"
	lbr
	line
}

### Function tput_pos ######################################

function tput_pos {
tput sc
line=$[$1+9]
column=23
tput cup $line $column
printf "$2"
tput rc
}

### Function build gui #####################################

function build_gui {
lbr
# reminder
# effect_options=()
# user_values=(0 0 0 0 0 0 0 0 0 0 )
# max_values=()
# step_size=(
gui_text "Name"
gui_balken "Position" "Max Value" "Step Size" "+" "-"
i=0
index="${#effect_options[*]}"
while [[ "$i" -lt "$index" ]]; do
	gui_text "${effect_options[$i]}"
#	gui_balken "${user_values[$i]}" "${max_values[$i]}" "${step_size[$i]}" "${option_key[$y]}" "${option_key[$y+1]}"
	gui_balken "" "${max_values[$i]}" "${step_size[$i]}" "${option_key[$y]}" "${option_key[$y+1]}"
	tput_pos "$i" "${user_values[$i]}"

	i=$[$i+1]
	y=$[$y+2]
done
lbr
unset y
unset i
unset index
}

### Function refresh_gui ##################################
function refresh_gui {
clear
header
build_gui
footer
}

### Function play_all #####################################
function play_all {
	save
}

### Function sox_play #####################################
function sox_play {
temp_effect="$EFFECT_NAME"
i=0
index="${#effect_options[*]}" 
while [[ "$i" -lt "$index" ]]; do
	if [[ $( echo "${user_values[$i]} < 1 " |bc ) -eq "1" ]]; then
		usr_values='0'"${user_values[$i]}"
	else
		usr_values="${user_values[$i]}"
	fi
	temp_effect="$temp_effect"' '"$usr_values"
	i=$[$i+1]
done
echo $temp_effect > temp.effect
killall play 1>&/dev/null
play -q test.wav $( cat temp.effect) &
unset i
unset index
unset usr_values
}

### Function KeyPress #####################################
# reminder
# effect_options=()
# user_values=(0 0 0 0 0 0 0 0 0 0 )
# max_values=()
# step_size=(

function keypress {
case "$1" in 
	q) stop=1 ;;
	p) sox_play ;;
	e) load_user_values; refresh_gui ;;
	r) reset_user_values; refresh_gui ;;
	t) save ;;
	z) delete_bank; refresh_gui ;;
	o) refresh_gui ;;
	i) play_all ;;
	u) save_all ;;
	[0-9]) preload $1; refresh_gui ;;
	*)
		i=0
		y=0
		index=${#option_key[*]}
		while [[ "$i" -lt "$index" ]]; do
			if [[ "$1" = "${option_key[$i]}" ]]; then
				if [[ $( echo "$i % 2" | bc ) -eq "0" ]]; then
				        if [[ $( echo "${user_values[$y]} < ${max_values[$y]}" |bc ) -eq "1" ]]; then 	user_values[$y]=$( echo "${user_values[$y]}+${step_size[$y]}" | bc ); fi
				else
				        if [[ $( echo "${user_values[$y]} > 0" |bc ) -eq "1" ]]; then user_values[$y]=$( echo "${user_values[$y]}-${step_size[$y]}" | bc ); fi
				fi
				### repair point failure
		                usr_val_str=${user_values[$y]}
				if [[  ${usr_val_str:0:1} == "." ]]; then
	        	                user_values[$y]='0'"${user_values[$y]}"
		                fi
				tput_pos "$y" "${user_values[$y]}"
				i=$index
			fi
			i=$[$i+1]
			if [[ $( echo "$i % 2" | bc ) -eq "0" ]]; then y=$[$y+1]; fi
		done
		unset usr_val_str
		unset i
		unset y
		unset index ;;
esac
}
### Working zone ##########################################
stop=0
refresh_gui
while [[ "$stop" = 0 ]]; do
	tput_pos
	read -s -n 1 key
	keypress $key

done
